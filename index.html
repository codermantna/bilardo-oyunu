<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HTML5 Bilardo (8-Ball – Demo)</title>
  <style>
    :root{
      --felt:#157a52;      /* masa rengi */
      --wood:#6b3e2e;      /* bant/ahşap */
      --chalk:#2b2f77;     /* UI aksan */
      --light:#f5f7fb;     /* açık metin */
      --muted:#9aa3b2;     /* ikincil metin */
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#0c0f14;color:#e7ebf3;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .card{background:linear-gradient(180deg,#121620,#0c0f14);border:1px solid #1e2430;border-radius:18px;box-shadow:0 8px 30px rgba(0,0,0,.35);overflow:hidden}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 16px;border-bottom:1px solid #1f2633;background:#0f141c;position:sticky;top:0;z-index:2}
    .brand{display:flex;align-items:center;gap:10px}
    .brand strong{font-weight:700;letter-spacing:.2px}
    .pill{font-size:12px;padding:3px 8px;border-radius:999px;background:var(--chalk);color:#fff;opacity:.85}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
    button{cursor:pointer;border:1px solid #273042;background:#121826;color:#dbe2f2;padding:10px 12px;border-radius:12px;font-weight:600;letter-spacing:.2px;transition:transform .08s ease,box-shadow .2s ease,border-color .2s ease}
    button:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.25);border-color:#3a4a66}
    button:disabled{opacity:.55;cursor:not-allowed}
    .stat{font-size:12px;color:var(--muted)}
    .canvasWrap{position:relative;background:#0a0d11}
    canvas{display:block;width:100%;height:auto;user-select:none;touch-action:none;outline:none}
    .hint{padding:10px 16px;color:#aab3c5;border-top:1px solid #1f2633;background:#0f141c}
    .legend{display:flex;gap:14px;flex-wrap:wrap}
    .legend span{font-size:12px;color:#b9c2d3}
    .badge{padding:4px 8px;border-radius:8px;background:#162032;border:1px solid #1f2b44}
    .tests{font-size:12px;margin-top:10px;color:#a6b0c3}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div class="brand"><span class="pill">HTML5</span> <strong>Bilardo – 8-Ball (Demo)</strong></div>
        <div class="controls">
          <button id="btnNewRack">Yeniden Diz</button>
          <button id="btnPractice">Serbest Antrenman</button>
          <button id="btnToggleGuide">Kılavuz Çizgi</button>
          <button id="btnMute">Sesi Aç/Kapat</button>
        </div>
      </div>
      <div class="canvasWrap">
        <canvas id="table" width="1000" height="520" aria-label="Billiards Table"></canvas>
      </div>
      <div class="hint">
        <div class="legend">
          <span class="badge">Vuruş: Fareyi basılı tutup çek – bırak</span>
          <span class="badge">Güç: Çekme mesafesi</span>
          <span class="badge">Mobil: Parmağını sürükleyip bırak</span>
          <span class="badge">R: Yeniden başlat • T: Testleri çalıştır</span>
        </div>
      </div>
    </div>
    <div class="stat" id="stat"></div>
    <div class="tests" id="tests"></div>
  </div>

  <audio id="sfxHit" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAChAAAAAAA=" type="audio/wav">
  </audio>

  <script>
  (()=>{
    const canvas = document.getElementById('table');
    const ctx = canvas.getContext('2d');
    const statEl = document.getElementById('stat');
    const testsEl = document.getElementById('tests');

    // Masa boyutları (iç alan)
    const W = 900, H = 450;                 // iç keçe alanı
    const BORDER = 40;                      // bant kalınlığı
    const POCKET_R = 22;                    // cep yarıçapı
    const BALL_R = 10.5;                    // top yarıçapı
    const FRICTION = 0.992;                 // sürtünme
    const ROLL_STOP = 0.05;                 // durma eşiği (px/frame)
    const MAX_POWER = 22;                   // maksimum vuruş hızı

    let showGuide = true;
    let practiceMode = false;
    let muted = false;

    const sfx = document.getElementById('sfxHit');
    function ping(){ if(!muted){ try{ sfx.currentTime = 0; sfx.play(); }catch(e){} } }

    // Dünya koordinatları için ofset
    const origin = {x: (canvas.width - W)/2, y: (canvas.height - H)/2};

    // Cepler: 6 adet
    const pockets = [
      {x: origin.x, y: origin.y},
      {x: origin.x + W/2, y: origin.y - 2},
      {x: origin.x + W, y: origin.y},
      {x: origin.x, y: origin.y + H},
      {x: origin.x + W/2, y: origin.y + H + 2},
      {x: origin.x + W, y: origin.y + H},
    ];

    // Yardımcılar
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    function shade(color, percent){
      // Tüm yaygın CSS renk biçimlerini güvenli şekilde koyulaştır/aç
      // percent -100..100 (eksi: koyu)
      if(!color || typeof color !== 'string') return '#000';
      const c = color.trim();

      // #rgb / #rrggbb
      if(/^#([0-9a-f]{3}){1,2}$/i.test(c)){
        let r,g,b;
        if(c.length===4){
          r=parseInt(c[1]+c[1],16); g=parseInt(c[2]+c[2],16); b=parseInt(c[3]+c[3],16);
        }else{
          r=parseInt(c.slice(1,3),16); g=parseInt(c.slice(3,5),16); b=parseInt(c.slice(5,7),16);
        }
        const f = (x)=> clamp(Math.round(x + (percent/100)*255),0,255);
        return `rgb(${f(r)},${f(g)},${f(b)})`;
      }

      // rgb/rgba
      let m = c.match(/^rgba?\(\s*([\d.]+)\s*[;,\s]\s*([\d.]+)\s*[;,\s]\s*([\d.]+)(?:\s*[,/]\s*([\d.]+))?\s*\)$/i);
      if(m){
        let r=+m[1], g=+m[2], b=+m[3];
        const f = (x)=> clamp(Math.round(x + (percent/100)*255),0,255);
        return `rgb(${f(r)},${f(g)},${f(b)})`;
      }

      // hsl/hsla (virgüllü veya boşluklu sözdizimi)
      m = c.match(/^hsla?\(\s*([\-\d.]+)(?:deg)?(?:\s*,\s*|\s+)([\d.]+)%(?:\s*,\s*|\s+)([\d.]+)%(?:\s*[,/]\s*[\d.]+)?\s*\)$/i);
      if(m){
        let h = +m[1]; let s = +m[2]; let l = +m[3];
        l = clamp(l + percent, 0, 100);
        return `hsl(${h} ${s}% ${l}%)`;
      }

      // Bilinmeyen format: hiç dokunma (en azından geçerli ise kalsın)
      return c;
    }

    // Top sınıfı
    class Ball{
      constructor(x,y,color,id){
        this.x=x; this.y=y; this.vx=0; this.vy=0; this.color=color; this.id=id;
        this.inPocket=false; this.isCue=(id===0);
        this.number=id; // görsel numara
      }
      get speed(){ return Math.hypot(this.vx,this.vy); }
      step(){ if(this.inPocket) return; this.x+=this.vx; this.y+=this.vy; this.vx*=FRICTION; this.vy*=FRICTION; if(this.speed<ROLL_STOP){ this.vx=0; this.vy=0; } }
    }

    let balls=[]; let cueBall; let canShoot=true; let aiming=false; let aim={x:0,y:0,px:0,py:0};

    function rack8(){
      balls.length=0;
      // Beyaz top
      cueBall = new Ball(origin.x + W*0.25, origin.y + H/2, '#ffffff', 0);
      balls.push(cueBall);
      // Üçgen dizi
      const colors = [
        '#f94144','#f3722c','#f8961e','#f9844a','#f9c74f','#90be6d','#43aa8b','#577590',
        '#7b2cbf','#ef476f','#ffd166','#06d6a0','#118ab2','#073b4c','#ff7b00'
      ];
      let idx=1; let startX = origin.x + W*0.72; let startY = origin.y + H/2;
      for(let r=0;r<5;r++){
        for(let c=0;c<=r;c++){
          const x = startX + r*(BALL_R*2*0.98);
          const y = startY - r*BALL_R + c*(BALL_R*2);
          const b = new Ball(x,y,colors[(idx-1)%colors.length], idx);
          balls.push(b); idx++;
        }
      }
      canShoot=true; aiming=false; practiceMode=false;
    }

    function practiceRack(){
      // Serbest yerleşim + HSL renkler
      balls.length=0;
      cueBall = new Ball(origin.x + W*0.25, origin.y + H/2, '#ffffff', 0);
      balls.push(cueBall);
      for(let i=1;i<=6;i++){
        const x = origin.x + W*0.35 + Math.random()*W*0.5;
        const y = origin.y + BALL_R + Math.random()*(H-2*BALL_R);
        const hue = (i*60)%360;
        balls.push(new Ball(x,y,`hsl(${hue} 70% 55%)`, i));
      }
      practiceMode=true; canShoot=true; aiming=false;
    }

    function resetCueAfterScratch(){
      cueBall.inPocket=false;
      cueBall.x = origin.x + W*0.25; cueBall.y = origin.y + H/2;
      cueBall.vx=cueBall.vy=0; canShoot=true;
    }

    function drawTable(){
      // Arka plan
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // Ahşap çerçeve
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--wood');
      roundRect(ctx, origin.x- BORDER, origin.y- BORDER, W+2*BORDER, H+2*BORDER, 18, true);
      // Keçe
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--felt');
      roundRect(ctx, origin.x, origin.y, W, H, 14, true);
      // Bant çizgileri
      ctx.strokeStyle = 'rgba(255,255,255,.05)';
      ctx.lineWidth = 2;
      ctx.strokeRect(origin.x+6, origin.y+6, W-12, H-12);
      // Cepler
      for(const p of pockets){
        const grad = ctx.createRadialGradient(p.x,p.y,4,p.x,p.y,POCKET_R+6);
        grad.addColorStop(0,'#000'); grad.addColorStop(1,'#0008');
        ctx.fillStyle = grad;
        ctx.beginPath(); ctx.arc(p.x,p.y,POCKET_R+6,0,Math.PI*2); ctx.fill();
        ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(p.x,p.y,POCKET_R,0,Math.PI*2); ctx.fill();
      }
    }

    function drawBalls(){
      for(const b of balls){ if(b.inPocket) continue; drawBall(b); }
    }

    function drawBall(b){
      const shadow=4;
      // gölge
      ctx.fillStyle='rgba(0,0,0,.25)';
      ctx.beginPath(); ctx.ellipse(b.x+shadow*0.6,b.y+shadow, BALL_R*1.05, BALL_R*0.7, 0, 0, Math.PI*2); ctx.fill();
      // top
      const g = ctx.createRadialGradient(b.x-4,b.y-4,3,b.x,b.y,BALL_R+1);
      g.addColorStop(0,'#fff'); g.addColorStop(0.15,'#fff'); g.addColorStop(0.16,b.color);
      // Renk güvenliği: shade her formatı destekliyor; yine de başarısız olursa temel renge düş
      let dark;
      try{ dark = shade(b.color,-12); }catch{ dark = b.color; }
      g.addColorStop(1, dark);
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(b.x,b.y,BALL_R,0,Math.PI*2); ctx.fill();
      // numara noktası
      ctx.fillStyle=b.isCue?'#ddd':'#f3f6fb';
      if(!b.isCue){ ctx.beginPath(); ctx.arc(b.x,b.y, BALL_R*0.5, 0, Math.PI*2); ctx.fill(); }
      // numara yazı
      if(!b.isCue){ ctx.fillStyle='#111'; ctx.font = 'bold 10px system-ui, sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(String(b.number), b.x, b.y+0.3); }
    }

    function drawAim(){
      if(!aiming||!showGuide) return;
      const {px,py,x,y} = aim;
      ctx.save();
      ctx.setLineDash([6,6]);
      ctx.lineWidth=2; ctx.strokeStyle='#e8edf7aa';
      ctx.beginPath(); ctx.moveTo(px,py); ctx.lineTo(x,y); ctx.stroke();
      // güç göstergesi
      const d = Math.min(MAX_POWER, Math.hypot(x-px,y-py));
      ctx.setLineDash([]); ctx.lineWidth=8; ctx.strokeStyle='#4cc9f080';
      ctx.beginPath(); ctx.moveTo(px,py); ctx.lineTo(px + (px-x)*d/80, py + (py-y)*d/80); ctx.stroke();
      ctx.restore();
    }

    function roundRect(ctx,x,y,w,h,r,fill){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      if(fill) ctx.fill(); else ctx.stroke();
    }

    function physics(){
      // Hareket
      for(const b of balls){ b.step(); }
      // Çarpışmalar (top-top)
      for(let i=0;i<balls.length;i++){
        const A = balls[i]; if(A.inPocket) continue;
        // bantlar
        if(A.x - BALL_R < origin.x){ A.x = origin.x + BALL_R; A.vx = Math.abs(A.vx); ping(); }
        if(A.x + BALL_R > origin.x + W){ A.x = origin.x + W - BALL_R; A.vx = -Math.abs(A.vx); ping(); }
        if(A.y - BALL_R < origin.y){ A.y = origin.y + BALL_R; A.vy = Math.abs(A.vy); ping(); }
        if(A.y + BALL_R > origin.y + H){ A.y = origin.y + H - BALL_R; A.vy = -Math.abs(A.vy); ping(); }

        // cepler
        for(const p of pockets){
          const dx=A.x-p.x, dy=A.y-p.y; const d=Math.hypot(dx,dy);
          if(d < POCKET_R*0.92){
            A.inPocket = true; A.vx=A.vy=0; ping();
            if(A.isCue){ setTimeout(resetCueAfterScratch, 600); }
          }
        }

        for(let j=i+1;j<balls.length;j++){
          const B = balls[j]; if(B.inPocket) continue;
          const dx = B.x - A.x, dy = B.y - A.y; const dist = Math.hypot(dx,dy);
          const minDist = BALL_R*2;
          if(dist>0 && dist < minDist){
            // yerleşim düzeltme
            const overlap = (minDist - dist)/2;
            const nx = dx/dist, ny = dy/dist;
            A.x -= nx*overlap; A.y -= ny*overlap;
            B.x += nx*overlap; B.y += ny*overlap;
            // 1D elastik çarpışma projeksiyonu
            const dvx = B.vx - A.vx, dvy = B.vy - A.vy;
            const rel = dvx*nx + dvy*ny;
            if(rel>0){ continue; }
            const impulse = -1.02 * rel; // biraz enerji kaybı
            A.vx -= impulse*nx; A.vy -= impulse*ny;
            B.vx += impulse*nx; B.vy += impulse*ny;
            ping();
          }
        }
      }
      // Tüm toplar durdu mu?
      canShoot = balls.every(b => b.inPocket || (Math.abs(b.vx)<ROLL_STOP && Math.abs(b.vy)<ROLL_STOP));
    }

    function render(){
      drawTable();
      drawBalls();
      drawAim();
    }

    function loop(){ physics(); render(); ui(); requestAnimationFrame(loop); }

    function ui(){
      const left = (balls.filter(b=>!b.inPocket && !b.isCue).length);
      statEl.textContent = `Durum: ${canShoot? 'Vuruşa hazır' : 'Toplar dönüyor...'}  •  Masada kalan: ${left}  •  Mod: ${practiceMode?'Antrenman':'8-Ball'}`;
    }

    // Girdi (mouse/touch)
    function startAim(x,y){ if(!canShoot) return; aiming=true; aim.px=cueBall.x; aim.py=cueBall.y; aim.x=x; aim.y=y; }
    function moveAim(x,y){ if(!aiming) return; aim.x=x; aim.y=y; }
    function releaseAim(){ if(!aiming) return; const dx = aim.x - aim.px; const dy = aim.y - aim.py; const d = Math.hypot(dx,dy); const p = Math.min(d, MAX_POWER); const ang = Math.atan2(dy,dx); cueBall.vx += -Math.cos(ang)*p; cueBall.vy += -Math.sin(ang)*p; aiming=false; canShoot=false; }

    canvas.addEventListener('mousedown', (e)=>{
      const rect=canvas.getBoundingClientRect(); startAim(e.clientX-rect.left, e.clientY-rect.top);
    });
    window.addEventListener('mousemove',(e)=>{
      const rect=canvas.getBoundingClientRect(); moveAim(e.clientX-rect.left, e.clientY-rect.top);
    });
    window.addEventListener('mouseup',()=>{ releaseAim(); });

    // Touch
    canvas.addEventListener('touchstart',(e)=>{ const t=e.changedTouches[0]; const r=canvas.getBoundingClientRect(); startAim(t.clientX-r.left,t.clientY-r.top); e.preventDefault(); },{passive:false});
    canvas.addEventListener('touchmove',(e)=>{ const t=e.changedTouches[0]; const r=canvas.getBoundingClientRect(); moveAim(t.clientX-r.left,t.clientY-r.top); e.preventDefault(); },{passive:false});
    canvas.addEventListener('touchend',()=>{ releaseAim(); });

    // Butonlar
    document.getElementById('btnNewRack').onclick = rack8;
    document.getElementById('btnPractice').onclick = practiceRack;
    document.getElementById('btnToggleGuide').onclick = ()=>{ showGuide=!showGuide; };
    document.getElementById('btnMute').onclick = ()=>{ muted=!muted; };
    window.addEventListener('keydown',(e)=>{ if(e.key.toLowerCase()==='r') rack8(); if(e.key.toLowerCase()==='t') runSelfTests(); });

    // Basit kendi kendini test (test cases)
    function runSelfTests(){
      const results = [];
      function test(name, fn){
        try{ fn(); results.push(`✅ ${name}`); }
        catch(err){ console.error(err); results.push(`❌ ${name} → ${err.message}`); }
      }
      // Test 1: shade hex
      test('shade("#ff0000", -12) geçerli renk döndürür', ()=>{
        const col = shade('#ff0000', -12);
        const g = ctx.createRadialGradient(0,0,0,0,0,10);
        g.addColorStop(1, col);
      });
      // Test 2: shade rgb()
      test('shade("rgb(10,20,30)", -12) geçerli renk', ()=>{
        const col = shade('rgb(10,20,30)', -12);
        const g = ctx.createRadialGradient(0,0,0,0,0,10);
        g.addColorStop(1, col);
      });
      // Test 3: shade hsl() (hata sebebimiz buydu)
      test('shade("hsl(120 70% 55%)", -12) geçerli renk', ()=>{
        const col = shade('hsl(120 70% 55%)', -12);
        const g = ctx.createRadialGradient(0,0,0,0,0,10);
        g.addColorStop(1, col);
      });
      // Test 4: practice rack çiziminde hata atmamalı
      test('practiceRack çizimi hatasız', ()=>{
        practiceRack();
        drawTable();
        drawBalls();
      });
      testsEl.textContent = `Testler: \n` + results.join('\n');
      return results.every(r=>r.startsWith('✅'));
    }

    // İlk başlat
    rack8();
    runSelfTests();
    loop();
  })();
  </script>
</body>
</html>
